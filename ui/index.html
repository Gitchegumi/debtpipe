<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DebtPipe ðŸ’¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        body { background-color: #0f172a; color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .tab-active { border-bottom: 2px solid #10b981; color: #10b981; }
        .sticky-col { position: sticky; left: 0; background: #0f172a; z-index: 10; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen font-sans">
    <div class="max-w-7xl mx-auto">
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-emerald-500 rounded-lg shadow-lg shadow-emerald-500/20"><i data-lucide="banknote" class="text-white"></i></div>
                <h1 class="text-3xl font-bold tracking-tight text-white">DebtPipe</h1>
            </div>
            <div class="hidden sm:block text-sm text-slate-400 font-medium">Unlimited Debt Payoff Simulator</div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <!-- Left Column: Inputs -->
            <div class="xl:col-span-1 space-y-6">
                <section class="glass p-6 rounded-2xl">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-emerald-400">
                        <i data-lucide="settings-2" class="w-4 h-4"></i> Settings
                    </h2>
                    <div class="space-y-4 text-sm font-medium text-slate-300">
                        <div>
                            <label class="block text-xs uppercase tracking-wider text-slate-500 mb-2 font-bold">Start Date</label>
                            <input type="month" id="startDate" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs uppercase tracking-wider text-slate-500 mb-2 font-bold">Method</label>
                            <select id="method" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                                <option value="snowball">Snowball (Smallest First)</option>
                                <option value="avalanche">Avalanche (Highest Rate First)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs uppercase tracking-wider text-slate-500 mb-2 font-bold">Extra Monthly Payment ($)</label>
                            <input type="number" id="extra" value="500" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none transition-all text-emerald-400">
                        </div>
                    </div>
                </section>

                <section class="glass p-6 rounded-2xl">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2 text-emerald-400">
                        <i data-lucide="list" class="w-4 h-4"></i> Debt Data
                    </h2>
                    <div class="flex flex-col gap-3">
                        <button onclick="document.getElementById('csvInput').click()" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg p-2.5 flex items-center justify-center gap-2 transition-all group">
                            <i data-lucide="upload" class="w-4 h-4 group-hover:text-emerald-400"></i> Upload CSV/TSV
                        </button>
                        <input type="file" id="csvInput" class="hidden" accept=".csv,.tsv,.txt" onchange="handleFileUpload(event)">
                        
                        <textarea id="debtData" rows="10" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 font-mono text-xs focus:ring-2 focus:ring-emerald-500 outline-none transition-all" placeholder="Name, Balance, Rate, Min, [DueDay]"></textarea>
                        
                        <div class="flex gap-2 pt-2">
                            <button onclick="runSimulation()" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg shadow-emerald-900/40">
                                <i data-lucide="play" class="w-4 h-4 fill-current"></i> Run
                            </button>
                            <button onclick="exportToPDF()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-xl transition-all flex items-center justify-center gap-2" title="Export Plan to PDF">
                                <i data-lucide="file-text" class="w-4 h-4 text-emerald-400"></i>
                            </button>
                            <button onclick="clearData()" class="bg-slate-800 hover:bg-rose-900/30 text-slate-500 hover:text-rose-400 p-3 rounded-xl transition-all border border-slate-700" title="Clear All Data">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Column: Results -->
            <div class="xl:col-span-3 space-y-6" id="report-content">
                <!-- Metrics Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="glass p-5 rounded-2xl border-l-4 border-emerald-500">
                        <div class="text-[10px] uppercase text-slate-500 font-extrabold mb-1 tracking-widest">Time to Freedom</div>
                        <div class="text-2xl font-bold text-white" id="metric-months">0 Months</div>
                        <div class="text-xs text-slate-400" id="metric-date">Payoff Date: --</div>
                    </div>
                    <div class="glass p-5 rounded-2xl border-l-4 border-amber-500">
                        <div class="text-[10px] uppercase text-slate-500 font-extrabold mb-1 tracking-widest">Total Interest</div>
                        <div class="text-2xl font-bold text-amber-400" id="metric-interest">$0.00</div>
                        <div class="text-xs text-slate-400">Paid to banks</div>
                    </div>
                    <div class="glass p-5 rounded-2xl border-l-4 border-rose-500">
                        <div class="text-[10px] uppercase text-slate-500 font-extrabold mb-1 tracking-widest">Total Cost</div>
                        <div class="text-2xl font-bold text-rose-400" id="metric-total">$0.00</div>
                        <div class="text-xs text-slate-400">Principal + Interest</div>
                    </div>
                    <div class="glass p-5 rounded-2xl border-l-4 border-blue-500">
                        <div class="text-[10px] uppercase text-slate-500 font-extrabold mb-1 tracking-widest">Monthly Flow</div>
                        <div class="text-2xl font-bold text-blue-400" id="metric-budget">$0.00</div>
                        <div class="text-xs text-slate-400">Total fixed commitment</div>
                    </div>
                </div>

                <!-- Main Chart -->
                <section class="glass p-6 rounded-2xl h-[350px]">
                    <canvas id="payoffChart"></canvas>
                </section>

                <!-- Schedule Section -->
                <section class="glass rounded-2xl overflow-hidden">
                    <div class="border-b border-slate-700/50 flex bg-slate-800/30">
                        <button onclick="switchTab('milestones')" id="tab-milestones" class="p-4 px-6 text-sm font-bold transition-all tab-active">Milestones</button>
                        <button onclick="switchTab('timeline')" id="tab-timeline" class="p-4 px-6 text-sm font-bold text-slate-400 hover:text-white transition-all">Full Timeline View</button>
                    </div>

                    <!-- Milestones View -->
                    <div id="view-milestones" class="p-0">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm border-collapse">
                                <thead class="bg-slate-800/50 text-slate-400 uppercase text-[10px] tracking-widest font-bold">
                                    <tr>
                                        <th class="p-4">Payoff Order</th>
                                        <th class="p-4">Debt Name</th>
                                        <th class="p-4 text-center">Interest Rate</th>
                                        <th class="p-4 text-center">Month #</th>
                                        <th class="p-4 text-right">Target Date</th>
                                    </tr>
                                </thead>
                                <tbody id="milestonesBody" class="divide-y divide-slate-700/50 text-slate-300">
                                    <!-- Dynamic -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Timeline View (Transposed) -->
                    <div id="view-timeline" class="p-0 hidden">
                        <div class="overflow-auto max-h-[600px]">
                            <table class="w-full text-left text-xs border-collapse">
                                <thead id="timelineHeader" class="bg-slate-800 text-slate-400 uppercase text-[10px] tracking-widest sticky top-0 z-20">
                                    <!-- Month/Date Headers -->
                                </thead>
                                <tbody id="timelineBody" class="divide-y divide-slate-700/50 text-slate-400">
                                    <!-- Rows: Debts, X-Axis: Months -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        let chartInstance = null;

        window.onload = () => {
            const now = new Date();
            document.getElementById('startDate').value = now.toISOString().slice(0, 7);
            
            const savedData = localStorage.getItem('debtpipe_data');
            const savedExtra = localStorage.getItem('debtpipe_extra');
            const savedMethod = localStorage.getItem('debtpipe_method');
            const savedStart = localStorage.getItem('debtpipe_start');
            
            if (savedData) document.getElementById('debtData').value = savedData;
            if (savedExtra) document.getElementById('extra').value = savedExtra;
            if (savedMethod) document.getElementById('method').value = savedMethod;
            if (savedStart) document.getElementById('startDate').value = savedStart;
            
            lucide.createIcons();
            runSimulation();
        };

        function switchTab(view) {
            const mTab = document.getElementById('tab-milestones');
            const tTab = document.getElementById('tab-timeline');
            const mView = document.getElementById('view-milestones');
            const tView = document.getElementById('view-timeline');

            if (view === 'milestones') {
                mTab.classList.add('tab-active'); mTab.classList.remove('text-slate-400');
                tTab.classList.remove('tab-active'); tTab.classList.add('text-slate-400');
                mView.classList.remove('hidden');
                tView.classList.add('hidden');
            } else {
                tTab.classList.add('tab-active'); tTab.classList.remove('text-slate-400');
                mTab.classList.remove('tab-active'); mTab.classList.add('text-slate-400');
                tView.classList.remove('hidden');
                mView.classList.add('hidden');
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const rows = text.split(/\r?\n/).filter(r => r.trim());
                const cleanData = rows.map(r => {
                    const separator = r.includes('\t') ? '\t' : ',';
                    return r.split(separator).map(cell => cell.trim().replace(/[$,]/g, '')).join(', ');
                }).join('\n');
                document.getElementById('debtData').value = cleanData;
                runSimulation();
            };
            reader.readAsText(file);
        }

        function clearData() {
            if (confirm("Clear all data and reset?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function runSimulation() {
            const rawData = document.getElementById('debtData').value;
            const extraPayment = parseFloat(document.getElementById('extra').value) || 0;
            const method = document.getElementById('method').value;
            const startVal = document.getElementById('startDate').value;

            localStorage.setItem('debtpipe_data', rawData);
            localStorage.setItem('debtpipe_extra', extraPayment);
            localStorage.setItem('debtpipe_method', method);
            localStorage.setItem('debtpipe_start', startVal);

            const baseDate = new Date(startVal + '-01T12:00:00'); // Midday to avoid TZ issues

            // 1. Parse
            const debts = rawData.trim().split('\n').map(line => {
                const parts = line.split(',').map(s => s.trim());
                return {
                    name: parts[0],
                    balance: parseFloat(parts[1]),
                    interestRate: parseFloat(parts[2]),
                    minPayment: parseFloat(parts[3]),
                    dueDay: parseInt(parts[4]) || 1
                };
            }).filter(d => !isNaN(d.balance));

            if (debts.length === 0) return;

            // 2. Sort for Priority
            const prioritizedDebts = [...debts];
            if (method === "snowball") {
                prioritizedDebts.sort((a, b) => a.balance - b.balance);
            } else {
                prioritizedDebts.sort((a, b) => b.interestRate - a.interestRate);
            }

            // 3. Simulate
            let currentMonth = 0;
            let totalInterest = 0;
            const initialPrincipal = debts.reduce((sum, d) => sum + d.balance, 0);
            const monthlyBudget = extraPayment + debts.reduce((sum, d) => sum + d.minPayment, 0);
            
            const timeline = []; // Will store { month, date, debtBalances: { name: bal }, debtPayments: { name: paid } }
            const milestones = []; // Will store { name, month, date, rate }
            
            let currentDebts = JSON.parse(JSON.stringify(prioritizedDebts));

            while (currentDebts.some(d => d.balance > 0) && currentMonth < 600) {
                currentMonth++;
                let budget = monthlyBudget;
                const monthDate = new Date(baseDate);
                monthDate.setMonth(baseDate.getMonth() + currentMonth - 1);
                const dateStr = monthDate.toLocaleString('default', { month: 'short', year: 'numeric' });

                const snapshot = { month: currentMonth, date: dateStr, balances: {}, payments: {}, interests: {}, total: 0 };

                // A. Accrue Interest
                currentDebts.forEach(d => {
                    let interest = 0;
                    if (d.balance > 0) {
                        interest = d.balance * ((d.interestRate / 100) / 12);
                        totalInterest += interest;
                        d.balance += interest;
                    }
                    snapshot.interests[d.name] = interest;
                });

                // B. Pay Minimums
                currentDebts.forEach(d => {
                    let paid = 0;
                    if (d.balance > 0) {
                        paid = Math.min(d.balance, d.minPayment);
                        d.balance -= paid;
                        budget -= paid;
                    }
                    snapshot.payments[d.name] = paid;
                });

                // C. Apply Snowball to Priority
                for (let d of currentDebts) {
                    if (d.balance > 0 && budget > 0) {
                        const extra = Math.min(d.balance, budget);
                        d.balance -= extra;
                        budget -= extra;
                        snapshot.payments[d.name] += extra;
                    }
                    
                    snapshot.balances[d.name] = d.balance;
                    snapshot.total += d.balance;

                    // Check for Payoff Milestone
                    if (d.balance === 0 && !milestones.find(m => m.name === d.name)) {
                        milestones.push({ name: d.name, month: currentMonth, date: dateStr, rate: d.interestRate });
                    }
                }

                timeline.push(snapshot);
            }

            // UI Update
            document.getElementById('metric-months').innerText = `${currentMonth} Months`;
            const finalDate = new Date(baseDate);
            finalDate.setMonth(baseDate.getMonth() + currentMonth - 1);
            document.getElementById('metric-date').innerText = `Payoff Date: ${finalDate.toLocaleString('default', { month: 'long', year: 'numeric' })}`;
            document.getElementById('metric-interest').innerText = `$${totalInterest.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('metric-total').innerText = `$${(initialPrincipal + totalInterest).toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('metric-budget').innerText = `$${monthlyBudget.toLocaleString()}`;

            renderMilestones(milestones, prioritizedDebts);
            renderTimelineTransposed(timeline, prioritizedDebts.map(d => d.name));
            updateChart(timeline);
        }

        function renderMilestones(milestones, allDebts) {
            // Ensure all debts are shown, even if not yet paid (in case of limit)
            const payoffOrder = milestones.map(m => m.name);
            const remaining = allDebts.filter(d => !payoffOrder.includes(d.name)).map(d => d.name);
            
            const combined = [...milestones, ...remaining.map(name => ({ name, month: '--', date: '--', rate: allDebts.find(d => d.name === name).interestRate }))];

            document.getElementById('milestonesBody').innerHTML = combined.map((m, i) => `
                <tr class="hover:bg-slate-800/30 transition-colors">
                    <td class="p-4 text-slate-500 font-mono">#${i + 1}</td>
                    <td class="p-4 font-bold text-white">${m.name}</td>
                    <td class="p-4 text-center text-slate-400 font-medium">${m.rate}%</td>
                    <td class="p-4 text-center font-medium">${m.month}</td>
                    <td class="p-4 text-right text-emerald-400 font-extrabold">${m.date}</td>
                </tr>
            `).join('');
        }

        function renderTimelineTransposed(timeline, debtNames) {
            // Y-Axis: Debts
            // X-Axis: Months/Dates
            
            // Header: Month names
            const headerRow = `<tr><th class="p-3 bg-slate-800 sticky-col z-30 min-w-[150px]">Debt Name</th>` + 
                timeline.map(step => `<th class="p-3 text-center border-l border-slate-700/50 min-w-[100px]">${step.date}</th>`).join('') + `</tr>`;
            document.getElementById('timelineHeader').innerHTML = headerRow;

            // Rows: One row per debt
            document.getElementById('timelineBody').innerHTML = debtNames.map(name => `
                <tr class="hover:bg-slate-800/20 group">
                    <td class="p-3 font-bold text-slate-200 sticky-col z-10 group-hover:bg-slate-800 transition-colors">${name}</td>
                    ${timeline.map(step => {
                        const bal = step.balances[name];
                        const paid = step.payments[name];
                        const interest = step.interests[name];
                        const isZero = bal === 0 && (timeline[timeline.indexOf(step)-1]?.balances[name] > 0 || timeline.indexOf(step) === 0);
                        return `
                            <td class="p-3 text-center border-l border-slate-700/30 ${isZero ? 'bg-emerald-900/20' : ''}">
                                <div class="${bal === 0 ? 'text-emerald-500 font-bold' : 'text-slate-300'}">${bal === 0 ? 'PAID' : '$' + bal.toLocaleString(undefined, {maximumFractionDigits:0})}</div>
                                ${paid > 0 ? `<div class="text-[9px] text-emerald-500 font-bold italic">Pay $${paid.toLocaleString(undefined, {maximumFractionDigits:0})}</div>` : ''}
                                ${interest > 0 ? `<div class="text-[9px] text-rose-500 font-medium">Int. $${interest.toLocaleString(undefined, {maximumFractionDigits:0})}</div>` : ''}
                            </td>
                        `;
                    }).join('')}
                </tr>
            `).join('');
        }

        function updateChart(timeline) {
            const ctx = document.getElementById('payoffChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeline.map(d => d.date),
                    datasets: [{
                        label: 'Remaining Debt',
                        data: timeline.map(d => d.total),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true, tension: 0.4, borderWidth: 3, pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', callback: v => '$' + v.toLocaleString() } },
                        x: { grid: { display: false }, ticks: { color: '#64748b', autoSkip: true, maxTicksLimit: 12 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function exportToPDF() {
            const element = document.getElementById('report-content');
            html2pdf().set({
                margin: [10, 5],
                filename: 'DebtPipe_Report.pdf',
                html2canvas: { scale: 2, backgroundColor: '#0f172a' },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            }).from(element).save();
        }
    </script>
</body>
</html>
